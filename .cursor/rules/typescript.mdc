---
globs: *.ts,*.js
---

# TypeScript 开发规则

## 版本信息
- **TypeScript**: v5.8.3+
- **ESLint**: v9.30.1+
- **Prettier**: v3.6.2+

## 配置文件
- **TypeScript 配置**: [tsconfig.json](mdc:tsconfig.json)
- **ESLint 配置**: [eslint.config.js](mdc:eslint.config.js)
- **Prettier 配置**: [prettier.config.js](mdc:prettier.config.js)

## 编译选项
基于 [tsconfig.json](mdc:tsconfig.json) 的配置：
```json
{
  "compilerOptions": {
    "target": "ESNext",
    "module": "ESNext",
    "lib": ["ESNext", "DOM"],
    "strict": true,
    "sourceMap": true,
    "moduleResolution": "Node"
  }
}
```

## 类型定义

### 基本类型
```typescript
// 基本类型声明
const message: string = "Hello";
const count: number = 42;
const isActive: boolean = true;
const items: string[] = ["a", "b", "c"];
```

### 对象类型
```typescript
// 接口定义
interface Post {
  id: string;
  title: string;
  content: string;
  publishTime: Date;
  author: User;
  tags: Tag[];
}

interface User {
  id: string;
  displayName: string;
  email: string;
}

// 类型别名
type Theme = 'light' | 'dark';
type PostStatus = 'draft' | 'published' | 'archived';
```

### 函数类型
```typescript
// 函数声明
function formatDate(date: Date): string {
  return date.toLocaleDateString('zh-CN');
}

// 箭头函数
const toggleTheme = (current: Theme): Theme => {
  return current === 'light' ? 'dark' : 'light';
};

// 异步函数
async function fetchPosts(): Promise<Post[]> {
  const response = await fetch('/api/posts');
  return response.json();
}
```

## Alpine.js 类型支持

### 组件类型定义
```typescript
// Alpine.js 组件类型
interface AlpineComponent {
  [key: string]: any;
}

// 主题切换组件
function themeToggle(): AlpineComponent {
  return {
    isDark: false,
    init() {
      this.isDark = localStorage.getItem('theme') === 'dark';
      this.updateTheme();
    },
    toggle() {
      this.isDark = !this.isDark;
      this.updateTheme();
    },
    updateTheme() {
      localStorage.setItem('theme', this.isDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', this.isDark ? 'dark' : 'light');
    }
  };
}
```

### 事件处理类型
```typescript
// 事件处理器类型
type EventHandler<T = Event> = (event: T) => void;

// 表单提交处理
const handleSubmit: EventHandler<SubmitEvent> = (event) => {
  event.preventDefault();
  // 处理表单提交
};
```

## DOM 操作类型

### 元素选择
```typescript
// DOM 元素类型
const button = document.querySelector('.btn') as HTMLButtonElement;
const input = document.querySelector('#search') as HTMLInputElement;
const form = document.querySelector('form') as HTMLFormElement;

// 安全的元素选择
function getElement<T extends HTMLElement>(selector: string): T | null {
  return document.querySelector(selector) as T | null;
}
```

### 事件监听
```typescript
// 事件监听器
button?.addEventListener('click', (event: MouseEvent) => {
  console.log('Button clicked', event.target);
});

// 自定义事件
interface CustomEventDetail {
  themeChanged: { theme: Theme };
}

const themeEvent = new CustomEvent<CustomEventDetail['themeChanged']>('themeChanged', {
  detail: { theme: 'dark' }
});
```

## 模块化开发

### 导入导出
```typescript
// 导出类型和函数
export interface Config {
  apiUrl: string;
  theme: Theme;
}

export function formatDate(date: Date): string {
  return date.toLocaleDateString('zh-CN');
}

export default class ThemeManager {
  private current: Theme = 'light';
  
  toggle(): Theme {
    this.current = this.current === 'light' ? 'dark' : 'light';
    return this.current;
  }
}
```

### 模块声明
```typescript
// 为第三方库添加类型声明
declare module 'some-library' {
  export function doSomething(): void;
}

// 全局变量声明
declare global {
  interface Window {
    Alpine: any;
  }
}
```

## 错误处理

### 类型守卫
```typescript
// 类型守卫函数
function isString(value: unknown): value is string {
  return typeof value === 'string';
}

function isPost(value: unknown): value is Post {
  return (
    typeof value === 'object' &&
    value !== null &&
    'id' in value &&
    'title' in value
  );
}

// 使用类型守卫
if (isPost(data)) {
  // 这里 data 被推断为 Post 类型
  console.log(data.title);
}
```

### 异常处理
```typescript
// 错误类型定义
class ApiError extends Error {
  constructor(
    message: string,
    public statusCode: number,
    public response?: Response
  ) {
    super(message);
    this.name = 'ApiError';
  }
}

// 异步错误处理
async function fetchData(): Promise<Post[]> {
  try {
    const response = await fetch('/api/posts');
    if (!response.ok) {
      throw new ApiError('Failed to fetch posts', response.status, response);
    }
    return await response.json();
  } catch (error) {
    if (error instanceof ApiError) {
      console.error('API Error:', error.message, error.statusCode);
    } else {
      console.error('Unknown error:', error);
    }
    throw error;
  }
}
```

## 实用类型

### 工具类型
```typescript
// 使用内置工具类型
type PartialPost = Partial<Post>;
type PostTitle = Pick<Post, 'title'>;
type PostWithoutId = Omit<Post, 'id'>;

// 自定义工具类型
type Optional<T, K extends keyof T> = Omit<T, K> & Partial<Pick<T, K>>;
type RequiredFields<T, K extends keyof T> = T & Required<Pick<T, K>>;
```

### 条件类型
```typescript
// 条件类型
type ApiResponse<T> = T extends string 
  ? { message: T }
  : { data: T };

// 映射类型
type ReadonlyPost = {
  readonly [K in keyof Post]: Post[K];
};
```

## 代码质量

### 严格模式
```typescript
// 启用严格模式检查
// - strictNullChecks: true
// - noImplicitAny: true
// - noImplicitReturns: true

// 正确的空值检查
function processUser(user: User | null): string {
  if (!user) {
    return 'No user';
  }
  return user.displayName; // 类型安全
}
```

### ESLint 规则
主要遵循的规则：
- 使用 const/let 而非 var
- 优先使用箭头函数
- 避免 any 类型
- 使用类型断言时要谨慎

### Prettier 格式化
```typescript
// 格式化规则
const config = {
  printWidth: 120,
  tabWidth: 2,
  useTabs: false,
  semi: true,
  singleQuote: true,
  trailingComma: 'es5',
};
```

## 开发工具

### 编译和构建
```bash
# TypeScript 编译
npx tsc

# 开发模式（监听文件变化）
pnpm dev

# 代码检查
pnpm lint

# 代码格式化
pnpm prettier
```

### 调试支持
```typescript
// 启用 sourceMap 以便调试
// tsconfig.json 中设置 "sourceMap": true

// 使用 console.log 进行调试
console.log('Debug info:', { post, user });

// 使用 debugger 语句
function complexFunction() {
  debugger; // 浏览器会在此处暂停
  // 复杂逻辑
}
```
