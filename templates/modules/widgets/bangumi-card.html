<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">

<!-- ========================================== -->
<!--   追番轮播卡片 - 自动轮播番剧               -->
<!--   竖版海报风格，淡入淡出切换                 -->
<!-- ========================================== -->

<th:block th:fragment="card">
  <!-- 读取配置 -->
  <th:block th:with="cardCfg = ${theme.config.bangumi_settings?.card_settings},
                     typeNum = ${cardCfg?.type_num ?: 1},
                     status = ${cardCfg?.status ?: 2},
                     size = ${cardCfg?.size ?: 6},
                     statusLabels = ${ {'全部', '想看', '在看', '已看'} },
                     typeLabels = ${ {'', '追番', '追剧'} }">

    <th:block th:with="bangumiList = ${bangumiFinder.list({page: 1, size: size, typeNum: typeNum, status: status})},
                       allStats = ${bangumiFinder.list({page: 1, size: 1, typeNum: typeNum, status: 0})}">

      <div th:if="${bangumiList != null && bangumiList.items != null && !bangumiList.items.isEmpty()}"
           class="bangumi-carousel-card"
           x-data="{ 
             current: 0, 
             total: 0,
             timer: null,
             paused: false,
             init() {
               this.total = this.$refs.slides.children.length;
               if (this.total > 1) this.autoPlay();
             },
             autoPlay() {
               this.timer = setInterval(() => {
                 if (!this.paused) this.next();
               }, 4000);
             },
             next() {
               this.current = (this.current + 1) % this.total;
             },
             goTo(i) {
               this.current = i;
             }
           }"
           @mouseenter="paused = true"
           @mouseleave="paused = false">
        
        <!-- 主卡片区域 -->
        <a href="/bangumis" class="block relative rounded-2xl overflow-hidden aspect-[3/4] group shadow-lg">
          
          <!-- 轮播封面容器 -->
          <div class="absolute inset-0" x-ref="slides">
            <th:block th:each="bangumi, iter : ${bangumiList.items}">
              <div class="absolute inset-0 transition-opacity duration-700"
                   th:data-index="${iter.index}"
                   x-bind:class="current == $el.dataset.index ? 'opacity-100 z-10' : 'opacity-0 z-0'">
                <img th:src="${#strings.contains(bangumi.spec.cover, '@') ? #strings.substringBefore(bangumi.spec.cover, '@') : bangumi.spec.cover}"
                     th:alt="${bangumi.spec.title}"
                     class="w-full h-full object-cover"
                     referrerpolicy="no-referrer"
                     loading="lazy" />
                <!-- 渐变遮罩 -->
                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/30 to-transparent"></div>
                <!-- 番剧信息 -->
                <div class="absolute bottom-0 left-0 right-0 p-4">
                  <h3 class="text-white font-bold text-base truncate" th:text="${bangumi.spec.title}">番剧名称</h3>
                  <div class="flex items-center gap-2 text-white/80 text-xs mt-1">
                    <span th:if="${bangumi.spec.totalCount}" th:text="${bangumi.spec.totalCount}">全12话</span>
                    <span th:if="${bangumi.spec.score}" class="flex items-center gap-0.5 text-warning">
                      <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                      </svg>
                      <span th:text="${bangumi.spec.score}">9.0</span>
                    </span>
                  </div>
                </div>
              </div>
            </th:block>
          </div>

          <!-- 顶部标签 - 仅显示轮播进度 -->
          <div class="absolute top-3 right-3 z-20">
            <span class="px-2 py-1 rounded-full bg-black/60 text-white text-xs backdrop-blur-sm">
              <span x-text="current + 1">1</span>/<span th:text="${#lists.size(bangumiList.items)}">1</span>
            </span>
          </div>


        </a>

        <!-- 指示器 -->
        <div th:if="${#lists.size(bangumiList.items) > 1}" class="flex justify-center gap-1.5 mt-3">
          <th:block th:each="bangumi, iter : ${bangumiList.items}">
            <button th:data-idx="${iter.index}"
                    @click="goTo(parseInt($el.dataset.idx))"
                    class="h-1.5 rounded-full transition-all duration-300"
                    x-bind:class="current == $el.dataset.idx ? 'w-5 bg-primary' : 'w-1.5 bg-base-content/20 hover:bg-base-content/40'">
            </button>
          </th:block>
        </div>

        <!-- 统计栏 -->
        <div class="flex items-center justify-around mt-3 py-2.5 rounded-xl bg-base-200/60 text-xs">
          <div class="text-center">
            <div class="text-base-content/50 text-[10px]">总数</div>
            <div class="font-bold" th:text="${allStats?.total ?: 0}">0</div>
          </div>
          <div class="w-px h-5 bg-base-content/10"></div>
          <div class="text-center">
            <div class="text-base-content/50 text-[10px]" th:text="${statusLabels[status]}">在看</div>
            <div class="font-bold text-primary" th:text="${bangumiList.total}">0</div>
          </div>
          <div class="w-px h-5 bg-base-content/10"></div>
          <div class="text-center">
            <div class="text-base-content/50 text-[10px]">类型</div>
            <div class="font-bold" th:text="${typeNum == 1 ? '番剧' : '剧集'}">番剧</div>
          </div>
        </div>
      </div>

    </th:block>
  </th:block>
</th:block>

</html>
