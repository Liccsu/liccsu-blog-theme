<!doctype html>
<html xmlns:th="https://www.thymeleaf.org">
  <!-- ========================================== -->
  <!--          主题切换内联脚本（防闪烁）          -->
  <!-- ========================================== -->

  <!--
  此脚本必须在 <head> 中尽早执行，在页面渲染前应用主题
  避免页面加载时的主题闪烁问题
  
  优先级逻辑：
  1. 如果前端开关开启 && localStorage 有缓存 → 使用缓存主题
  2. 否则 → 使用默认配置主题
-->
  <script th:fragment="inline-script" th:inline="javascript">
    (function () {
      // === 主题初始化 ===
      const showThemeToggle = /*[[${theme.config.nav.theme_settings.show_theme_toggle}]]*/ true;
      const savedTheme = localStorage.getItem("theme-mode");
      const defaultTheme = /*[[${theme.config.nav.theme_settings.default_theme}]]*/ "system";
      const lightTheme = /*[[${theme.config.nav.theme_settings.light_theme}]]*/ "light";
      const darkTheme = /*[[${theme.config.nav.theme_settings.dark_theme}]]*/ "dark";

      // 向后兼容：旧值映射
      let mode = savedTheme;
      if (mode === "light_theme") mode = "light";
      if (mode === "dark_theme") mode = "dark";

      // 无缓存或前端开关关闭时使用默认值
      if (!mode || !showThemeToggle) {
        if (defaultTheme === "light_theme") mode = "light";
        else if (defaultTheme === "dark_theme") mode = "dark";
        else mode = defaultTheme; // 'system'
      }

      // 计算 isDark 状态
      let isDark;
      if (mode === "system") {
        isDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      } else {
        isDark = mode === "dark";
      }

      const themeName = isDark ? darkTheme : lightTheme;
      const themeMode = isDark ? "dark" : "light";

      document.documentElement.setAttribute("data-theme", themeName);
      document.documentElement.setAttribute("data-color-scheme", themeMode);

      // === 全局字体按需加载 ===
      const bodyFont = /*[[${theme.config.general.font_settings.body_font}]]*/ "font-default";
      const fontCdn = /*[[${theme.config.general.font_settings.font_cdn}]]*/ "https://cdn.5ee.net/fonts";

      // 加载字体文件
      if (bodyFont === "font-lxgw-wenkai-bright") {
        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = fontCdn + "/LXGWBright-SemiLight/result.css";
        document.head.appendChild(link);
      } else if (bodyFont === "font-siyuan-songti") {
        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = fontCdn + "/思源屏显臻宋/result.css";
        document.head.appendChild(link);
      }

      // 应用字体类到 html 元素（全局生效）
      if (bodyFont && bodyFont !== "font-default") {
        document.documentElement.classList.add(bodyFont);
      }
    })();
  </script>
</html>
