<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">

<!-- ========================================== -->
<!--           作者归档页主体内容               -->
<!-- 路由：/authors/:name                       -->
<!-- 变量：author (UserVo), posts (分页列表)    -->
<!-- ========================================== -->

<main class="relative" th:fragment="author-content"
  th:with="cfg = ${theme.config.author_settings},
               contentCfg = ${cfg?.content_settings},
               globalSidebarCfg = ${theme.config.general.sidebar_settings},
               useCustomSidebar = ${cfg?.enable_custom_sidebar == true},
               sidebarPosition = ${useCustomSidebar ? (cfg?.sidebar_position ?: 'right') : (globalSidebarCfg?.position ?: 'right')},
               pageSize = ${contentCfg?.page_size ?: 10},
               showMoments = ${contentCfg?.show_moments != false},
               momentsCount = ${contentCfg?.moments_count ?: 6},
               defaultTab = ${contentCfg?.default_tab ?: 'posts'}">
  
  <!-- 主体内容区域 -->
  <div class="max-w-7xl mx-auto px-4 py-8">
    <div class="flex gap-8" th:classappend="${sidebarPosition == 'left'} ? 'flex-row-reverse' : ''">
      
      <!-- 左侧：作者信息 + 内容区 -->
      <section class="flex-1 min-w-0" th:classappend="${cfg.show_sidebar != true ? 'max-w-4xl mx-auto' : ''}">
        
        <!-- ========== 作者信息卡片 ========== -->
        <div class="author-hero card bg-base-100/80 backdrop-blur-xl shadow-lg border border-base-content/5 rounded-2xl p-6 md:p-8 mb-8 relative overflow-hidden group hover:shadow-xl transition-all duration-300">
          <!-- 背景装饰 -->
          <div class="absolute -top-20 -right-20 w-48 h-48 bg-gradient-to-br from-primary/10 to-secondary/10 rounded-full blur-3xl group-hover:scale-110 transition-transform duration-500"></div>
          <div class="absolute -bottom-16 -left-16 w-40 h-40 bg-gradient-to-tr from-accent/10 to-primary/10 rounded-full blur-3xl group-hover:scale-110 transition-transform duration-500"></div>
          
          <div class="relative flex flex-col md:flex-row items-center md:items-start gap-6">
            <!-- 头像 -->
            <div class="flex-shrink-0">
              <div class="relative w-24 h-24 md:w-28 md:h-28 rounded-2xl overflow-hidden ring-2 ring-base-content/10 group-hover:ring-primary/30 transition-all shadow-lg">
                <img th:if="${author.spec.avatar != null and !#strings.isEmpty(author.spec.avatar)}"
                     th:src="${author.spec.avatar}" 
                     th:alt="${author.spec.displayName}"
                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" />
                <div th:unless="${author.spec.avatar != null and !#strings.isEmpty(author.spec.avatar)}"
                     class="w-full h-full bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center">
                  <span class="icon-[heroicons--user] w-12 h-12 md:w-14 md:h-14 text-primary/60"></span>
                </div>
              </div>
            </div>
            
            <!-- 作者信息 -->
            <div class="flex-1 text-center md:text-left min-w-0">
              <!-- 显示名称 -->
              <h1 class="text-2xl md:text-3xl font-bold text-base-content mb-1" th:text="${author.spec.displayName}">用户名</h1>
              
              <!-- @用户名 -->
              <p class="text-sm text-base-content/50 mb-3 flex items-center justify-center md:justify-start gap-1">
                <span class="icon-[heroicons--at-symbol] w-4 h-4"></span>
                <span th:text="${author.metadata.name}">username</span>
              </p>
              
              <!-- 个人简介 -->
              <p th:if="${author.spec.bio != null and !#strings.isEmpty(author.spec.bio)}"
                 class="text-base-content/70 leading-relaxed mb-4 line-clamp-2"
                 th:text="${author.spec.bio}">这是个人简介...</p>
              
              <!-- 统计信息 -->
              <div class="flex flex-wrap items-center justify-center md:justify-start gap-3 text-sm">
                <!-- 文章数 -->
                <div class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-primary/10 text-primary border border-primary/20">
                  <span class="icon-[heroicons--document-text] w-4 h-4"></span>
                  <span class="font-medium" th:text="${posts.total}">0</span>
                  <span class="text-primary/70">篇文章</span>
                </div>
                
                <!-- 瞬间数（如果启用） -->
                <div th:if="${showMoments}" 
                     class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-secondary/10 text-secondary border border-secondary/20"
                     th:with="authorMoments = ${momentFinder.listAll()}">
                  <span class="icon-[heroicons--camera] w-4 h-4"></span>
                  <span class="font-medium author-moments-count" data-author-name="${author.metadata.name}">0</span>
                  <span class="text-secondary/70">条瞬间</span>
                </div>
                
                <!-- 注册时间 -->
                <div th:if="${author.spec.registeredAt != null}" 
                     class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-base-200/50 text-base-content/60 border border-base-content/5">
                  <span class="icon-[heroicons--calendar] w-4 h-4"></span>
                  <span>加入于</span>
                  <span th:text="${#temporals.format(author.spec.registeredAt, 'yyyy-MM-dd')}">2024-01-01</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ========== Tab 切换区 ========== -->
        <div class="author-tabs mb-6" 
             x-data="authorTabs()" 
             th:attr="data-default-tab=${defaultTab}">
          <!-- Tab 按钮 -->
          <div class="flex items-center gap-1 border-b border-base-content/10">
            <button @click="activeTab = 'posts'" 
                    class="tab-btn px-4 py-2.5 font-medium text-sm transition-all"
                    :class="activeTab === 'posts' ? 'text-base-content border-b-2 border-primary -mb-px' : 'text-base-content/50 hover:text-base-content'">
              <span class="icon-[heroicons--document-text] w-4 h-4 mr-1.5 inline-block align-text-bottom"></span>
              文章
              <span class="ml-1 text-xs opacity-60" th:text="'(' + ${posts.total} + ')'"></span>
            </button>
            <button th:if="${showMoments}" @click="activeTab = 'moments'" 
                    class="tab-btn px-4 py-2.5 font-medium text-sm transition-all"
                    :class="activeTab === 'moments' ? 'text-base-content border-b-2 border-primary -mb-px' : 'text-base-content/50 hover:text-base-content'">
              <span class="icon-[heroicons--camera] w-4 h-4 mr-1.5 inline-block align-text-bottom"></span>
              瞬间
              <span class="ml-1 text-xs opacity-60 author-moments-tab-count"></span>
            </button>
          </div>
          
          <!-- ========== 文章列表 Tab ========== -->
          <div x-show="activeTab === 'posts'" x-transition:enter="transition ease-out duration-150" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
            
            <!-- 卡片文章列表 -->
            <div th:if="${posts.total > 0}" class="author-posts-list mt-6 space-y-4">
              <th:block th:each="post, stat : ${posts.items}">
                <article class="group card bg-base-100/80 backdrop-blur-xl border border-base-content/5 rounded-2xl p-4 md:p-5 flex flex-col md:flex-row md:items-stretch gap-4 md:gap-5 shadow-sm hover:shadow-md hover:border-primary/20 transition-all duration-300">
                  
                  <!-- 左侧封面 -->
                  <figure th:if="${post.spec.cover != null and !#strings.isEmpty(post.spec.cover)}" 
                          class="relative w-full md:w-40 md:h-28 shrink-0 overflow-hidden rounded-xl">
                    <a th:href="${post.status.permalink}" class="block w-full aspect-video md:aspect-auto md:h-full">
                      <img th:src="${post.spec.cover}" 
                           th:alt="${post.spec.title}"
                           loading="lazy"
                           class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" />
                    </a>
                  </figure>
                  
                  <!-- 右侧内容 -->
                  <div class="flex-1 flex flex-col min-w-0">
                    <!-- 标题 -->
                    <h3 class="text-base md:text-lg font-bold leading-snug">
                      <a th:href="${post.status.permalink}" 
                         class="hover:text-primary transition-colors"
                         th:text="${post.spec.title}">文章标题</a>
                    </h3>
                    
                    <!-- 摘要 -->
                    <p th:if="${post.status.excerpt != null and !#strings.isEmpty(post.status.excerpt)}"
                       class="mt-2 text-sm text-base-content/70 line-clamp-2 leading-relaxed">
                      <a th:href="${post.status.permalink}" 
                         class="hover:text-base-content"
                         th:text="${post.status.excerpt}">文章摘要...</a>
                    </p>
                    
                    <!-- 底部元信息 -->
                    <div class="mt-auto pt-3 flex flex-wrap items-center justify-between gap-y-2">
                      <!-- 左侧：分类 + 标签 -->
                      <div class="flex items-center gap-2 overflow-hidden">
                        <!-- 分类 -->
                        <span th:if="${post.categories != null and !post.categories.isEmpty()}"
                              class="inline-flex items-center px-2 py-0.5 rounded-md bg-primary/5 text-primary text-[10px] font-medium shrink-0">
                          <a th:href="${post.categories[0].status.permalink}" 
                             class="hover:underline max-w-[100px] truncate"
                             th:text="${post.categories[0].spec.displayName}">分类</a>
                        </span>
                        <!-- 标签 -->
                        <div th:if="${post.tags != null and !post.tags.isEmpty()}" 
                             class="flex items-center gap-2 text-xs text-base-content/50 truncate">
                          <th:block th:each="tag, tagStat : ${post.tags}" th:if="${tagStat.index < 3}">
                            <a th:href="${tag.status.permalink}" 
                               class="hover:text-primary transition-colors"
                               th:text="'#' + ${tag.spec.displayName}">#标签</a>
                          </th:block>
                        </div>
                      </div>
                      
                      <!-- 右侧：时间 + 统计 -->
                      <div class="flex items-center gap-2">
                        <span class="text-xs text-base-content/40"
                              th:text="${#temporals.format(post.spec.publishTime, 'yyyy-MM-dd')}">2024-01-01</span>
                        <div class="flex items-center gap-1.5 px-2 py-1 rounded-full bg-base-200/50 text-[10px] text-base-content/60">
                          <span class="icon-[heroicons--eye] w-3 h-3"></span>
                          <span th:text="${post.stats?.visit ?: 0}">0</span>
                        </div>
                        <div class="flex items-center gap-1.5 px-2 py-1 rounded-full bg-base-200/50 text-[10px] text-base-content/60">
                          <span class="icon-[heroicons--chat-bubble-left] w-3 h-3"></span>
                          <span th:text="${post.stats?.comment ?: 0}">0</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </article>
              </th:block>
            </div>
            
            <!-- 空状态 -->
            <div th:if="${posts.total == 0}" 
                 class="card bg-base-100/80 backdrop-blur-sm border border-base-content/5 rounded-xl p-12 text-center mt-6">
              <span class="icon-[heroicons--document-magnifying-glass] w-16 h-16 text-base-content/20 mx-auto mb-4"></span>
              <p class="text-base-content/60">该作者暂未发布任何文章</p>
            </div>
            
            <!-- 分页 -->
            <div th:if="${posts.totalPages > 1}" class="mt-8 flex items-center justify-center">
              <div class="inline-flex items-center p-1 rounded-full bg-base-200/60 backdrop-blur-md">
                <!-- 上一页 -->
                <a th:href="${posts.prevUrl}" 
                   class="w-9 h-9 flex items-center justify-center rounded-full text-base-content/60 hover:text-base-content hover:bg-base-100 transition-all duration-200"
                   th:classappend="${!posts.hasPrevious} ? 'opacity-30 pointer-events-none' : ''">
                  <span class="icon-[heroicons--chevron-left] w-5 h-5"></span>
                </a>
                <!-- 页码 -->
                <span class="px-4 text-xs font-semibold text-base-content/50 tabular-nums tracking-wide"
                      th:text="${posts.page} + ' / ' + ${posts.totalPages}">1 / 1</span>
                <!-- 下一页 -->
                <a th:href="${posts.nextUrl}" 
                   class="w-9 h-9 flex items-center justify-center rounded-full text-base-content/60 hover:text-base-content hover:bg-base-100 transition-all duration-200"
                   th:classappend="${!posts.hasNext} ? 'opacity-30 pointer-events-none' : ''">
                  <span class="icon-[heroicons--chevron-right] w-5 h-5"></span>
                </a>
              </div>
            </div>
          </div>
          
          <!-- ========== 瞬间列表 Tab ========== -->
          <div th:if="${showMoments}" x-show="activeTab === 'moments'" x-cloak
               x-transition:enter="transition ease-out duration-200" 
               x-transition:enter-start="opacity-0 translate-y-2" 
               x-transition:enter-end="opacity-100 translate-y-0">
            
            <!-- 瞬间网格 -->
            <div class="author-moments-grid mt-6 grid grid-cols-1 md:grid-cols-2 gap-4"
                 th:with="authorName = ${author.metadata.name}">
              
              <th:block th:each="moment, stat : ${momentFinder.listAll()}" 
                        th:if="${moment.owner?.name == author.metadata.name and stat.index < momentsCount}">
                <article class="author-moment-item card bg-base-100/80 backdrop-blur-sm border border-base-content/5 rounded-xl overflow-hidden hover:shadow-lg hover:border-secondary/20 transition-all duration-300 group"
                         th:with="content = ${moment.spec.content}">
                  
                  <!-- 瞬间头部 -->
                  <div class="p-4 pb-3">
                    <!-- 时间 -->
                    <div class="flex items-center gap-2 text-xs text-base-content/50 mb-3">
                      <span class="icon-[heroicons--clock] w-3.5 h-3.5"></span>
                      <time th:text="${#temporals.format(moment.spec.releaseTime, 'MM月dd日 HH:mm')}">01-01 12:00</time>
                    </div>
                    
                    <!-- 文字内容 -->
                    <div th:if="${content.html != null and !#strings.isEmpty(content.html)}"
                         class="text-sm text-base-content leading-relaxed line-clamp-4"
                         th:utext="${content.html}">瞬间内容...</div>
                  </div>
                  
                  <!-- 媒体区域 -->
                  <div th:if="${content.medium != null and !content.medium.isEmpty()}" class="px-4 pb-3">
                    <!-- 单图/多图 -->
                    <div class="rounded-lg overflow-hidden"
                         th:classappend="${#lists.size(content.medium) > 1} ? 'grid grid-cols-2 gap-1' : ''">
                      <th:block th:each="medium, mediumStat : ${content.medium}" th:if="${mediumStat.index < 4}">
                        <div th:if="${medium.type.name == 'PHOTO'}" 
                             class="relative aspect-square bg-base-200 overflow-hidden cursor-pointer group/img">
                          <img th:src="${medium.url}" 
                               class="w-full h-full object-cover group-hover/img:scale-105 transition-transform duration-300"
                               loading="lazy" />
                          <!-- 更多图片指示 -->
                          <div th:if="${mediumStat.index == 3 and #lists.size(content.medium) > 4}"
                               class="absolute inset-0 bg-black/50 flex items-center justify-center">
                            <span class="text-white font-semibold" th:text="'+' + (${#lists.size(content.medium)} - 4)">+2</span>
                          </div>
                        </div>
                        <div th:if="${medium.type.name == 'VIDEO' and mediumStat.index == 0}" class="col-span-2">
                          <video th:src="${medium.url}" controls preload="metadata" class="w-full rounded-lg max-h-48"></video>
                        </div>
                      </th:block>
                    </div>
                  </div>
                  
                  <!-- 标签 -->
                  <div th:if="${moment.spec.tags != null and !moment.spec.tags.isEmpty()}" class="px-4 pb-3">
                    <div class="flex flex-wrap gap-1.5">
                      <span th:each="tag : ${moment.spec.tags}" 
                            class="badge badge-sm badge-ghost text-secondary"
                            th:text="'#' + ${tag}">#标签</span>
                    </div>
                  </div>
                  
                  <!-- 互动操作 -->
                  <div class="px-4 py-3 border-t border-base-content/5 flex items-center gap-4 text-xs text-base-content/50">
                    <!-- 点赞 -->
                    <span class="flex items-center gap-1.5">
                      <span class="icon-[heroicons--heart] w-4 h-4"></span>
                      <span th:text="${moment.stats?.upvote ?: 0}">0</span>
                    </span>
                    <!-- 评论 -->
                    <span class="flex items-center gap-1.5">
                      <span class="icon-[heroicons--chat-bubble-left] w-4 h-4"></span>
                      <span th:text="${moment.stats?.totalComment ?: 0}">0</span>
                    </span>
                    <!-- 查看详情 -->
                    <a th:href="@{'/moments/' + ${moment.metadata.name}}" 
                       class="ml-auto flex items-center gap-1 text-secondary hover:underline">
                      <span>查看详情</span>
                      <span class="icon-[heroicons--arrow-right] w-3.5 h-3.5"></span>
                    </a>
                  </div>
                </article>
              </th:block>
            </div>
            
            <!-- 空状态 -->
            <div class="author-moments-empty hidden card bg-base-100/80 backdrop-blur-sm border border-base-content/5 rounded-xl p-12 text-center mt-6">
              <span class="icon-[heroicons--camera] w-16 h-16 text-base-content/20 mx-auto mb-4"></span>
              <p class="text-base-content/60">该作者暂未发布任何瞬间</p>
            </div>
            
            <!-- 查看更多瞬间链接 -->
            <div class="mt-6 text-center">
              <a href="/moments" class="btn btn-ghost btn-sm gap-1.5 text-secondary">
                <span>查看全部瞬间</span>
                <span class="icon-[heroicons--arrow-right] w-4 h-4"></span>
              </a>
            </div>
          </div>
        </div>
        
      </section>
      
      <!-- 右侧：侧边栏 -->
      <aside th:if="${cfg.show_sidebar == true}" 
             class="right-sidebar w-80 space-y-6 hidden lg:block sticky top-20 self-start">
        <th:block th:replace="~{modules/widgets/sidebar :: dynamic(${cfg})}" />
      </aside>
      
    </div>
  </div>
  
  <!-- 传递作者名称给 JS -->
  <script th:inline="javascript">
    window.AUTHOR_PAGE_CONFIG = {
      authorName: /*[[${author.metadata.name}]]*/ '',
      momentsCount: /*[[${momentsCount}]]*/ 6
    };
  </script>
</main>

</html>
