<!doctype html>
<html xmlns:th="https://www.thymeleaf.org">
  <!-- ============================================= -->
  <!--   Magazine 杂志风格：纯图片展示 + 悬浮信息     -->
  <!--   特点：默认纯图片，悬浮显示标题与元信息       -->
  <!-- ============================================= -->

  <section th:fragment="magazine(posts, settings)" class="grid grid-cols-1 gap-6 md:grid-cols-2">
    <article
      th:each="post : ${posts.items}"
      th:with="isPinned = ${post.spec.pinned == true},
                    isPrivate = ${post.spec.visible != null and post.spec.visible.name() == 'PRIVATE' and currentUser != null and currentUser.metadata.name == post.spec.owner},
                    isLocked = ${post.metadata.annotations != null and post.metadata.annotations['content.halo.run/content-restriction'] != null and post.metadata.annotations['content.halo.run/content-restriction'] != ''}"
      class="group border-base-content/5 relative overflow-hidden rounded-[2rem] border shadow-lg transition-all duration-700 ease-[cubic-bezier(0.25,0.1,0.25,1)] hover:shadow-2xl"
    >
      <!-- 封面计算 (Context-Aware Fix) -->
      <th:block
        th:with="
        nested = ${settings?.cover_fallback},
        flatEnable = ${settings?.cover_fallback_enable},
        flatMode = ${settings?.cover_fallback_mode},
        flatUrl = ${settings?.cover_fallback_url},
        enable = ${nested != null ? (nested.enable ?: false) : (flatEnable ?: false)},
        mode = ${nested != null ? (nested.mode ?: 'missing_only') : (flatMode ?: 'missing_only')},
        defaultImg = ${nested != null ? nested.default_image : flatUrl},
        actual=${post.spec.cover},
        actualOk=${actual != null and not #strings.isEmpty(actual) ? actual : null},
        coverUrl=${(enable == true) ? ((mode == 'always' and defaultImg != null) ? defaultImg : (actualOk != null ? actualOk : defaultImg)) : actualOk}
    "
      >
        <!-- 背景大图：16:10 比例 -->
        <div class="relative aspect-video overflow-hidden">
          <a th:href="@{${post.status.permalink}}" class="absolute inset-0 block">
            <img
              th:if="${coverUrl != null}"
              th:src="${coverUrl}"
              th:alt="|${post.spec.title} 的封面|"
              loading="lazy"
              class="absolute inset-0 h-full w-full scale-100 transform object-cover transition-transform duration-1000 ease-[cubic-bezier(0.25,0.1,0.25,1)] group-hover:scale-105"
            />
            <!-- 无封面占位 -->
            <div
              th:if="${coverUrl == null}"
              class="from-primary/15 via-secondary/10 to-accent/15 absolute inset-0 grid place-items-center bg-gradient-to-br"
            >
              <span class="icon-[heroicons--photo] text-primary/30 h-16 w-16"></span>
            </div>
          </a>

          <!-- 全局安全遮罩：确保浅色图片上的白字也能看清 -->
          <div class="pointer-events-none absolute inset-0 bg-black/10"></div>

          <!-- 置顶角标 -->
          <span
            th:if="${isPinned}"
            class="absolute top-3 left-3 z-10 rounded-md bg-gradient-to-r from-pink-500 to-rose-500 px-2 py-0.5 text-[10px] font-bold text-white shadow-sm backdrop-blur-md"
            >置顶</span
          >

          <!-- 渐变遮罩：双层设计 (对比度增强版) -->
          <!-- 1. 默认状态：底部渐变加深 (from-black/80 via-black/40)，保护常驻信息 -->
          <div
            class="pointer-events-none absolute inset-x-0 bottom-0 h-40 bg-gradient-to-t from-black/80 via-black/40 to-transparent transition-opacity duration-500 group-hover:opacity-0"
          ></div>

          <!-- 2. 悬浮状态：全屏沉浸渐变 (加深至 from-black/90 via-black/60)，确保标题绝对清晰 -->
          <div
            class="pointer-events-none absolute inset-0 bg-gradient-to-t from-black/90 via-black/60 to-transparent opacity-0 transition-opacity duration-700 ease-in-out group-hover:opacity-100"
          ></div>

          <!-- 内容层：Hover-Reveal 交互 -->
          <div class="pointer-events-none absolute right-0 bottom-0 left-0 flex flex-col justify-end px-6 pb-5">
            <!-- 揭示区域：手机默认显示，桌面端悬浮显示 -->
            <div
              class="grid grid-rows-[1fr] transition-all duration-700 ease-[cubic-bezier(0.25,0.1,0.25,1)] md:grid-rows-[0fr] md:group-hover:grid-rows-[1fr]"
            >
              <div class="overflow-hidden">
                <div class="flex flex-col items-start gap-3 pb-4">
                  <!-- 分类胶囊（上方）：手机默认显示，桌面悬浮动画 -->
                  <div
                    th:if="${!#lists.isEmpty(post.categories)}"
                    th:with="firstCat=${post.categories[0]}"
                    class="pointer-events-auto translate-y-0 transform opacity-100 transition-all delay-0 duration-500 ease-out md:translate-y-3 md:opacity-0 md:group-hover:translate-y-0 md:group-hover:opacity-100"
                  >
                    <a
                      th:href="@{${firstCat.status.permalink}}"
                      class="inline-block rounded-md bg-white/15 px-2.5 py-1 text-[11px] font-medium tracking-wide text-white/90 backdrop-blur-sm transition-colors hover:bg-white/25"
                      th:text="${firstCat.spec.displayName}"
                      >分类</a
                    >
                  </div>

                  <!-- 标题：手机默认显示，桌面悬浮动画 -->
                  <h3
                    class="pointer-events-auto line-clamp-2 translate-y-0 transform text-lg leading-snug font-bold tracking-tight text-white opacity-100 drop-shadow-lg transition-all delay-75 duration-600 ease-out md:translate-y-4 md:text-xl md:opacity-0 md:group-hover:translate-y-0 md:group-hover:opacity-100"
                  >
                    <a th:href="@{${post.status.permalink}}" th:text="${post.spec.title}">文章标题</a>
                  </h3>
                </div>
              </div>
            </div>

            <!-- 元信息栏：常驻可见 -->
            <div class="flex flex-wrap items-center gap-3 text-xs font-medium text-white/70">
              <!-- 日期 -->
              <span class="inline-flex items-center gap-1">
                <span class="icon-[heroicons--calendar-days] h-3.5 w-3.5 opacity-70"></span>
                <time th:text="${#dates.format(post.spec.publishTime,'yyyy-MM-dd')}">2025-01-01</time>
              </span>

              <span class="h-0.5 w-0.5 rounded-full bg-white/30"></span>

              <!-- 浏览量 -->
              <span class="inline-flex items-center gap-1">
                <span class="icon-[heroicons--eye] h-3.5 w-3.5 opacity-70"></span>
                <span th:text="${post.stats.visit ?: 0}">0</span>
              </span>

              <!-- 点赞 -->
              <span class="inline-flex items-center gap-1">
                <span class="icon-[heroicons--heart] h-3.5 w-3.5 opacity-70"></span>
                <span th:text="${post.stats.upvote ?: 0}">0</span>
              </span>
            </div>
          </div>
        </div>
      </th:block>
    </article>
  </section>
</html>
