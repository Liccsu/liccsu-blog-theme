<!doctype html>
<html xmlns:th="https://www.thymeleaf.org">
  <!-- ============================================= -->
  <!--   分类页专用：左图右文非卡片布局（media_text）   -->
  <!--   路径控制：仅在 /categories 与 /categories/:slug 使用 -->
  <!--   不使用卡片背景；图片左侧固定比例，右侧文字自适应 -->
  <!-- ============================================= -->

  <!-- 片段：media_text(posts) -->
  <section th:fragment="media_text(posts, settings)" class="space-y-8">
    <!-- 循环文章列表：使用非卡片、左图右文布局 -->
    <article
      th:each="post : ${posts.items}"
      th:with="isPinned = ${post.spec.pinned == true},
                    isPrivate = ${post.spec.visible != null and post.spec.visible.name() == 'PRIVATE' and currentUser != null and currentUser.metadata.name == post.spec.owner},
                    isLocked = ${post.metadata.annotations != null and post.metadata.annotations['content.halo.run/content-restriction'] != null and post.metadata.annotations['content.halo.run/content-restriction'] != ''}"
      class="group card bg-base-100/80 border-base-content/5 hover:border-primary/20 relative flex cursor-pointer flex-col gap-4 rounded-[1.5rem] border p-4 shadow-lg backdrop-blur-xl transition-all duration-300 hover:shadow-xl md:flex-row md:items-stretch md:gap-6 md:p-5"
    >
      <!-- 封面计算：支持主题的封面回退设置 (Context-Aware Fix) -->
      <th:block
        th:with="
        nested = ${settings?.cover_fallback},
        flatEnable = ${settings?.cover_fallback_enable},
        flatMode = ${settings?.cover_fallback_mode},
        flatUrl = ${settings?.cover_fallback_url},
        enable = ${nested != null ? (nested.enable ?: false) : (flatEnable ?: false)},
        mode = ${nested != null ? (nested.mode ?: 'missing_only') : (flatMode ?: 'missing_only')},
        defaultImg = ${nested != null ? (nested.default_image + '?id=' + post.metadata.name) : (flatUrl + '?id=' + post.metadata.name)},
        actual=${post.spec.cover},
        actualOk=${actual != null and not #strings.isEmpty(actual) ? actual : null},
        coverUrl=${(enable == true) ? ((mode == 'always' and defaultImg != null) ? defaultImg : (actualOk != null ? actualOk : defaultImg)) : actualOk}
    "
      >
        <!-- 左侧图片区域：4:3 比例 -->
        <figure class="relative w-full shrink-0 overflow-hidden rounded-xl md:max-w-[25%] md:basis-[25%]">
          <a th:href="@{${post.status.permalink}}" class="block aspect-4/3 w-full">
            <img
              th:if="${coverUrl != null}"
              th:src="${coverUrl}"
              th:alt="|${post.spec.title} 的封面|"
              loading="lazy"
              class="h-full w-full object-cover transition-transform duration-500 ease-out group-hover:scale-105"
            />
            <!-- 无封面占位：与有图片时尺寸完全一致 -->
            <div
              th:if="${coverUrl == null}"
              class="from-primary/15 via-secondary/10 to-accent/15 group-hover:from-primary/20 group-hover:to-accent/20 flex h-full w-full items-center justify-center bg-gradient-to-br transition-all duration-200"
            >
              <span
                class="icon-[heroicons--photo] text-primary/30 group-hover:text-primary/50 h-16 w-16 transition-colors"
              ></span>
            </div>
          </a>
          <!-- 置顶/推荐角标 -->
          <span
            th:if="${isPinned}"
            class="absolute top-2 left-2 rounded-md bg-gradient-to-r from-pink-500 to-rose-500 px-2 py-0.5 text-[10px] font-bold text-white shadow-sm backdrop-blur-md"
            >置顶</span
          >
        </figure>
      </th:block>

      <!-- 右侧文字区域：自适应高度与宽度，支持多段落排版 -->
      <div class="flex flex-1 flex-col">
        <!-- 标题：可点击，强调可读性 -->
        <h3 class="text-base leading-6 font-bold tracking-tight md:text-lg md:leading-7">
          <a
            th:href="@{${post.status.permalink}}"
            class="hover:text-primary transition-colors"
            th:text="${post.spec.title}"
            >文章标题</a
          >
        </h3>

        <!-- 摘要：响应式占满宽度，双行省略，移除固定宽度与高度以适配窄屏 -->
        <p class="text-base-content/70 mt-2 line-clamp-2 w-full text-sm leading-relaxed">
          <a
            th:href="@{${post.status.permalink}}"
            class="hover:text-base-content"
            th:text="${(post.spec.excerpt != null and post.spec.excerpt.raw != null and !post.spec.excerpt.raw.isEmpty()) ? post.spec.excerpt.raw : (post.status.excerpt ?: '')}"
          ></a>
        </p>

        <!-- 元信息行：固定在右侧内容底部；按要求分两行：
           行1（左）：分类 + 标签；行2（右）：时间 + 浏览量 + 点赞 + 评论 -->
        <div class="mt-auto flex flex-wrap items-center justify-between gap-y-2 pt-4">
          <!-- 行1（左）：分类 + 标签 -->
          <div
            class="flex items-center gap-2 overflow-hidden"
            th:with="firstCat=${!#lists.isEmpty(post.categories) ? post.categories[0] : null}, end=${post.tags.size() >= 4 ? 4 : post.tags.size()}, limited=${post.tags.subList(0, end)}"
          >
            <!-- 分类胶囊 -->
            <span
              class="bg-primary/5 text-primary inline-flex shrink-0 items-center rounded-md px-2 py-0.5 text-[10px] font-medium"
              th:if="${firstCat != null}"
            >
              <a
                th:href="@{${firstCat.status.permalink}}"
                class="max-w-[100px] truncate hover:underline"
                th:text="${firstCat.spec.displayName}"
                >分类</a
              >
            </span>

            <!-- 标签文字 -->
            <div class="text-base-content/50 flex items-center gap-2 truncate text-xs">
              <th:block th:each="tag : ${limited}">
                <a th:href="@{${tag.status.permalink}}" class="hover:text-primary transition-colors"
                  >#<span th:text="${tag.spec.displayName}">标签</span></a
                >
              </th:block>
            </div>
          </div>

          <!-- 行2（右）：元信息胶囊组 -->
          <div class="flex items-center gap-2">
            <!-- 时间 -->
            <span
              class="text-base-content/40 mr-1 text-xs"
              th:text="${#dates.format(post.spec.publishTime,'yyyy-MM-dd')}"
              >2025-01-01</span
            >

            <div
              class="bg-base-200/50 text-base-content/60 hover:bg-base-200 flex items-center gap-1.5 rounded-full px-2 py-1 text-[10px] transition-colors"
            >
              <span class="icon-[heroicons--eye] h-3 w-3"></span>
              <span th:text="${post.stats.visit ?: 0}">0</span>
            </div>
            <div
              class="bg-base-200/50 text-base-content/60 hover:bg-base-200 flex items-center gap-1.5 rounded-full px-2 py-1 text-[10px] transition-colors"
            >
              <span class="icon-[heroicons--heart] h-3 w-3"></span>
              <span th:text="${post.stats.upvote ?: 0}">0</span>
            </div>
            <div
              class="bg-base-200/50 text-base-content/60 hover:bg-base-200 flex items-center gap-1.5 rounded-full px-2 py-1 text-[10px] transition-colors"
            >
              <span class="icon-[heroicons--chat-bubble-left] h-3 w-3"></span>
              <span th:text="${post.stats.comment ?: 0}">0</span>
            </div>
          </div>
        </div>
      </div>
    </article>

    <!-- 分隔：列表项间自然留白由 space-y-8 控制，无需额外边框 -->
  </section>
</html>
