document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".steam-game-card img, .steam-recent-card img").forEach(t=>{t.addEventListener("error",function(){this.src='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 460 215"%3E%3Crect fill="%231b2838" width="460" height="215"/%3E%3Ctext x="50%25" y="50%25" fill="%2366c0f4" font-size="24" text-anchor="middle" dy=".3em"%3EğŸ®%3C/text%3E%3C/svg%3E'})}),document.querySelectorAll(".steam-game-card img, .steam-recent-card img").forEach(t=>{t.complete?t.classList.add("loaded"):t.addEventListener("load",function(){this.classList.add("loaded")})}),E(),S()});function E(){document.querySelectorAll(".steam-achievement-bar[data-progress]").forEach(t=>{const e=t.dataset.progress;if(!e)return;const r=e.match(/(\d+)\s*\/\s*(\d+)/);if(r){const n=parseInt(r[1],10),l=parseInt(r[2],10);if(l>0){const s=n/l*100,a=t.querySelector(".steam-achievement-fill");a&&requestAnimationFrame(()=>{a.style.width=`${s}%`})}}})}function w(t,e){if(e||(e=document.getElementById("steam-tooltip")),!e)return;t.querySelectorAll(".steam-heatmap-cell:not(.invisible)").forEach(n=>{const l=n.dataset.date,a=(parseInt(n.dataset.minutes||"0",10)/60).toFixed(1);n.addEventListener("mouseenter",()=>{const i=new Date(l),c=["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"],d=`${i.getMonth()+1}æœˆ${i.getDate()}æ—¥${c[i.getDay()]}`;e.innerHTML=`
        <div class="font-bold text-base-content/90">${d}</div>
        <div class="text-base-content/70 mt-1 flex items-center gap-1">
          <span class="font-mono text-sm">${a}</span> <span class="text-xs">å°æ—¶æ¸¸æˆæ—¶é—´</span>
        </div>
      `,e.style.display="block";const o=n.getBoundingClientRect();e.style.top=`${o.top-e.offsetHeight-8+window.scrollY}px`,e.style.left=`${o.left+o.width/2-e.offsetWidth/2}px`}),n.addEventListener("mouseleave",()=>{e.style.display="none"})})}async function S(){const t=document.getElementById("steam-heatmap-grid"),e=document.getElementById("steam-heatmap-loading"),r=document.getElementById("steam-heatmap-empty"),n=document.getElementById("steam-heatmap-error"),l=document.getElementById("steam-heatmap-tooltip");if(t)try{const s=parseInt(t.dataset.days||"365",10),a=t.dataset.apiUrl||t.closest(".steam-heatmap-inline")?.querySelector("[data-api-url]")?.dataset.apiUrl;if(console.log("[Steam Debug] Init Heatmap:",{heatmapDays:s,apiUrl:a,gridElId:t.id}),t.querySelectorAll(".steam-heatmap-cell:not(.invisible)").length>0&&!a){console.log("[Steam Debug] Server-rendered heatmap detected, skipping API fetch"),e&&(e.style.display="none"),w(t,l);return}if(!a){console.log("[Steam Debug] No API URL and no server-rendered data, showing empty state"),e&&(e.style.display="none"),r&&(r.style.display="flex");return}const c=await x(a,s);if(console.log("[Steam Debug] Data Received:",c),e?(e.style.display="none",console.log("[Steam Debug] Loading element hidden")):console.warn("[Steam Debug] Loading element NOT FOUND!"),!c||!c.items||c.items.length===0){console.warn("[Steam Debug] No items in heatmap data"),r&&(r.style.display="flex");return}const d=new Map;c.items.forEach(o=>{d.set(o.spec.date,o.spec.playtimeMinutes||0)}),console.log("[Steam Debug] DateMap:",Object.fromEntries(d)),b(t,d,s,l),console.log("[Steam Debug] Heatmap rendered successfully")}catch(s){console.error("Failed to render heatmap:",s),e&&(e.style.display="none"),n&&(n.style.display="flex")}}async function x(t,e){const r=new Date,n=new Date;n.setDate(n.getDate()-e);const l=i=>{const c=i.getFullYear(),d=String(i.getMonth()+1).padStart(2,"0"),o=String(i.getDate()).padStart(2,"0");return`${c}-${d}-${o}`},s=new URL(t,window.location.origin);s.searchParams.set("startDate",l(n)),s.searchParams.set("endDate",l(r)),s.searchParams.set("page","1"),s.searchParams.set("size",e),console.log("[Steam Debug] Fetching URL:",s.toString());const a=await fetch(s.toString());if(!a.ok)throw console.error("[Steam Debug] Fetch Failed:",a.status),new Error("Failed to fetch heatmap data");return await a.json()}function b(t,e,r,n){const l=new Date,s=new Date;s.setDate(s.getDate()-r),t.innerHTML="";let a=new Date(s);const i=a.getDay();a.setDate(a.getDate()-i);const c=o=>{const p=o.getFullYear(),f=String(o.getMonth()+1).padStart(2,"0"),m=String(o.getDate()).padStart(2,"0");return`${p}-${f}-${m}`};let d=0;for(;a<=l;){const o=c(a),p=e.get(o)||0,f=(p/60).toFixed(1);let m=0;p>0&&(m=1),p>120&&(m=2),p>240&&(m=3);let u;m===0?u="color-mix(in oklch, var(--color-base-content) 10%, transparent)":m===1?u="color-mix(in oklch, var(--color-primary) 30%, transparent)":m===2?u="color-mix(in oklch, var(--color-primary) 60%, transparent)":u="var(--color-primary)";const g=document.createElement("div");g.className="steam-heatmap-cell",g.style.backgroundColor=u,g.dataset.date=o,g.dataset.hours=f,g.dataset.minutes=p,g.addEventListener("mouseenter",h=>{const y=new Date(o),v=`${y.getMonth()+1}æœˆ${y.getDate()}æ—¥`;n.innerHTML=`
        <div style="font-weight:600;margin-bottom:4px;">${v}</div>
        <div style="opacity:0.9;">${f} å°æ—¶</div>
      `;const D=t.closest(".steam-layout")?.getBoundingClientRect()||{left:0,top:0};n.style.display="block",n.style.left=h.clientX-D.left+10+"px",n.style.top=h.clientY-D.top-50+"px"}),g.addEventListener("mouseleave",()=>{n.style.display="none"}),t.appendChild(g),a.setDate(a.getDate()+1),d++}console.log("[Steam Debug] Rendered cells:",d)}
