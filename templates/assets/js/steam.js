document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".steam-game-img, .steam-badge-img, .steam-avatar-img").forEach(s=>{s.complete&&s.naturalHeight!==0?s.classList.add("loaded"):(s.addEventListener("load",function(){this.classList.add("loaded")}),s.addEventListener("error",function(){this.classList.add("loaded"),this.src='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 460 215"%3E%3Crect fill="%231b2838" width="460" height="215"/%3E%3Ctext x="50%25" y="50%25" fill="%2366c0f4" font-size="24" text-anchor="middle" dy=".3em"%3EğŸ®%3C/text%3E%3C/svg%3E'}))}),D(),E()});function D(){document.querySelectorAll(".steam-achievement-bar[data-progress]").forEach(a=>{const e=a.dataset.progress;if(!e)return;const s=e.match(/(\d+)\s*\/\s*(\d+)/);if(s){const t=parseInt(s[1],10),l=parseInt(s[2],10);if(l>0){const o=t/l*100,n=a.querySelector(".steam-achievement-fill");n&&requestAnimationFrame(()=>{n.style.width=`${o}%`})}}})}function x(a,e){if(e||(e=document.getElementById("steam-tooltip")),!e)return;a.querySelectorAll(".steam-heatmap-cell:not(.invisible)").forEach(t=>{const l=t.dataset.date,n=(parseInt(t.dataset.minutes||"0",10)/60).toFixed(1);t.addEventListener("mouseenter",()=>{const c=new Date(l),d=["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"],i=`${c.getMonth()+1}æœˆ${c.getDate()}æ—¥${d[c.getDay()]}`;e.innerHTML=`
        <div class="font-bold text-base-content/90">${i}</div>
        <div class="text-base-content/70 mt-1 flex items-center gap-1">
          <span class="font-mono text-sm">${n}</span> <span class="text-xs">å°æ—¶æ¸¸æˆæ—¶é—´</span>
        </div>
      `,e.style.display="block";const r=t.getBoundingClientRect();e.style.top=`${r.top-e.offsetHeight-8+window.scrollY}px`,e.style.left=`${r.left+r.width/2-e.offsetWidth/2}px`}),t.addEventListener("mouseleave",()=>{e.style.display="none"})})}async function E(){const a=document.getElementById("steam-heatmap-grid"),e=document.getElementById("steam-heatmap-loading"),s=document.getElementById("steam-heatmap-empty"),t=document.getElementById("steam-heatmap-error"),l=document.getElementById("steam-heatmap-tooltip");if(a)try{const o=parseInt(a.dataset.days||"365",10),n=a.dataset.apiUrl||a.closest(".steam-heatmap-inline")?.querySelector("[data-api-url]")?.dataset.apiUrl;if(a.querySelectorAll(".steam-heatmap-cell:not(.invisible)").length>0&&!n){e&&(e.style.display="none"),x(a,l);return}if(!n){e&&(e.style.display="none"),s&&(s.style.display="flex");return}const d=await w(n,o);if(e&&(e.style.display="none"),!d||!d.items||d.items.length===0){s&&(s.style.display="flex");return}const i=new Map;d.items.forEach(r=>{i.set(r.spec.date,r.spec.playtimeMinutes||0)}),L(a,i,o,l)}catch(o){console.error("Failed to render heatmap:",o),e&&(e.style.display="none"),t&&(t.style.display="flex")}}async function w(a,e){const s=new Date,t=new Date;t.setDate(t.getDate()-e);const l=c=>{const d=c.getFullYear(),i=String(c.getMonth()+1).padStart(2,"0"),r=String(c.getDate()).padStart(2,"0");return`${d}-${i}-${r}`},o=new URL(a,window.location.origin);o.searchParams.set("startDate",l(t)),o.searchParams.set("endDate",l(s)),o.searchParams.set("page","1"),o.searchParams.set("size",e);const n=await fetch(o.toString());if(!n.ok)throw new Error("Failed to fetch heatmap data");return await n.json()}function L(a,e,s,t){const l=new Date,o=new Date;o.setDate(o.getDate()-s),a.innerHTML="";let n=new Date(o);const c=n.getDay();n.setDate(n.getDate()-c);const d=i=>{const r=i.getFullYear(),g=String(i.getMonth()+1).padStart(2,"0"),m=String(i.getDate()).padStart(2,"0");return`${r}-${g}-${m}`};for(;n<=l;){const i=d(n),r=e.get(i)||0,g=(r/60).toFixed(1);let m=0;r>0&&(m=1),r>120&&(m=2),r>240&&(m=3);let f;m===0?f="color-mix(in oklch, var(--color-base-content) 10%, transparent)":m===1?f="color-mix(in oklch, var(--color-primary) 30%, transparent)":m===2?f="color-mix(in oklch, var(--color-primary) 60%, transparent)":f="var(--color-primary)";const p=document.createElement("div");p.className="steam-heatmap-cell",p.style.backgroundColor=f,p.dataset.date=i,p.dataset.hours=g,p.dataset.minutes=r,p.addEventListener("mouseenter",y=>{const h=new Date(i),v=`${h.getMonth()+1}æœˆ${h.getDate()}æ—¥`;t.innerHTML=`
        <div style="font-weight:600;margin-bottom:4px;">${v}</div>
        <div style="opacity:0.9;">${g} å°æ—¶</div>
      `;const u=a.closest(".steam-layout")?.getBoundingClientRect()||{left:0,top:0};t.style.display="block",t.style.left=y.clientX-u.left+10+"px",t.style.top=y.clientY-u.top-50+"px"}),p.addEventListener("mouseleave",()=>{t.style.display="none"}),a.appendChild(p),n.setDate(n.getDate()+1)}}
