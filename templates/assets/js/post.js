document.addEventListener("alpine:init",()=>{Alpine.data("postLike",()=>({isLiked:!1,likeCount:0,postName:"",init(){const t=this.$el.closest("[data-post-name]");t&&(this.postName=t.dataset.postName||"",this.likeCount=parseInt(t.dataset.upvoteCount||"0"),this.checkLikeStatus())},checkLikeStatus(){if(!this.postName)return;const t=JSON.parse(localStorage.getItem("halo.upvoted.post.names")||"[]");this.isLiked=t.includes(this.postName)},async toggleLike(){if(this.postName&&!this.isLiked)try{const t=await fetch("/apis/api.halo.run/v1alpha1/trackers/upvote",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({group:"content.halo.run",plural:"posts",name:this.postName})});if(t.ok){this.isLiked=!0,this.likeCount+=1;const t=JSON.parse(localStorage.getItem("halo.upvoted.post.names")||"[]");t.includes(this.postName)||(t.push(this.postName),localStorage.setItem("halo.upvoted.post.names",JSON.stringify(t)))}else{await t.text()}}catch(t){}}})),Alpine.data("postComment",()=>({commentCount:0,init(){const t=this.$el.closest("[data-comment-count]");t&&(this.commentCount=parseInt(t.dataset.commentCount||"0"))},toggleCommentDrawer(){const t=document.getElementById("comment-drawer");t&&(t.checked=!t.checked)}})),Alpine.data("tocDrawer",()=>({isOpen:!1,init(){this.$nextTick(()=>{this.initTocDrawerContent()})},toggleDrawer(){this.isOpen=!this.isOpen},initTocDrawerContent(){const t=document.getElementById("toc-drawer-nav"),e=document.getElementById("toc-nav");if(!t)return;if(e&&e.innerHTML.trim())return t.innerHTML=e.innerHTML,void this.bindTocDrawerEvents();const n=document.getElementById("article-content");if(!n)return void(t.innerHTML='<p class="text-base-content/50 text-sm">暂无目录</p>');const o=n.querySelectorAll("h1, h2, h3, h4, h5, h6");0!==o.length?(this.generateTocContent(t,o),this.bindTocDrawerEvents()):t.innerHTML='<p class="text-base-content/50 text-sm">暂无目录</p>'},generateTocContent(t,e){const n=Array.from(e),o=n.map(t=>parseInt(t.tagName.charAt(1))),i=Math.min(...o),s=i+2,a=n.filter(t=>parseInt(t.tagName.charAt(1))<=s),r=document.createElement("ol");r.className="toc-list",a.forEach((t,e)=>{t.id||(t.id=`heading-${e}`);const n=parseInt(t.tagName.charAt(1))-i,o=document.createElement("li");o.className="toc-item-wrapper",o.style.setProperty("--toc-indent-multiplier",n.toString());const s=document.createElement("a");s.href=`#${t.id}`,s.textContent=t.textContent.trim(),s.className="toc-link",s.setAttribute("data-relative-level",n.toString()),s.setAttribute("data-heading-id",t.id),o.appendChild(s),r.appendChild(o)}),t.appendChild(r)},bindTocDrawerEvents(){const t=document.getElementById("toc-drawer-nav");if(!t)return;t.querySelectorAll(".toc-link").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault();const n=t.getAttribute("data-heading-id")||t.getAttribute("href").slice(1),o=document.getElementById(n);if(o){const t=80,e=o.offsetTop-t;window.scrollTo({top:e,behavior:"smooth"}),this.isOpen=!1}})})}}))}),function(){const t={init(){this.initWordCount(),this.initHeadingAnchors(),this.initTOC(),this.initReadingProgress(),this.initCodeCopy(),this.initScrollToTop()},initHeadingAnchors(){const t=document.getElementById("article-content");if(!t)return;t.querySelectorAll("h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]").forEach(t=>{const e=t.getAttribute("id");if(!e)return;t.style.position="relative",t.style.cursor="pointer";const n=document.createElement("a");n.href=`#${e}`,n.className="heading-anchor",n.innerHTML='<span class="icon-[heroicons--link] w-4 h-4"></span>',n.setAttribute("aria-label","复制链接"),n.style.cssText="\n                    position: absolute;\n                    left: -1.5em;\n                    top: 50%;\n                    transform: translateY(-50%);\n                    opacity: 0;\n                    transition: opacity 0.2s ease;\n                    color: var(--color-primary);\n                    text-decoration: none;\n                    display: inline-flex;\n                    align-items: center;\n                ",t.addEventListener("mouseenter",()=>{n.style.opacity="1"}),t.addEventListener("mouseleave",()=>{n.style.opacity="0"}),n.addEventListener("click",async t=>{t.preventDefault();const o=window.location.origin+window.location.pathname+`#${e}`;try{await navigator.clipboard.writeText(o),n.innerHTML='<span class="icon-[heroicons--check] w-4 h-4"></span>',setTimeout(()=>{n.innerHTML='<span class="icon-[heroicons--link] w-4 h-4"></span>'},2e3)}catch(i){}}),t.insertBefore(n,t.firstChild)})},initTOC(){const t=document.getElementById("toc-nav"),e=document.getElementById("toc-card");if(!t)return;const n=document.getElementById("article-content");if(!n)return void(e&&(e.style.display="none"));const o=n.querySelectorAll("h1, h2, h3, h4, h5, h6");if(0===o.length)return void(e&&(e.style.display="none"));const i=this.analyzeHeadingHierarchy(o);if(0===i.filteredHeadings.length)return void(e&&(e.style.display="none"));e&&(e.style.display="block");const s=this.buildDynamicTocTree(i.filteredHeadings,i.minLevel),a=this.createDynamicTocHTML(s);t.innerHTML="",t.appendChild(a),this.initTocScrollHighlight(i.filteredHeadings),this.initAdaptiveLayout()},analyzeHeadingHierarchy(t){const e=Array.from(t),n=e.map(t=>parseInt(t.tagName.charAt(1))),o=Math.min(...n),i=o+2;return{filteredHeadings:e.filter(t=>parseInt(t.tagName.charAt(1))<=i),minLevel:o,maxDisplayLevel:i,totalLevels:n.length>0?Math.max(...n)-o+1:0}},buildDynamicTocTree(t,e){const n=[],o=[];return t.forEach((t,i)=>{t.id||(t.id=`heading-${i}`);const s=parseInt(t.tagName.charAt(1)),a=s-e,r={id:t.id,text:t.textContent.trim(),absoluteLevel:s,relativeLevel:a,element:t,children:[]};for(;o.length>0&&o[o.length-1].relativeLevel>=a;)o.pop();0===o.length?n.push(r):o[o.length-1].children.push(r),o.push(r)}),n},createDynamicTocHTML(t){const e=document.createElement("ol");return e.className="toc-list",t.forEach(t=>{const n=document.createElement("li");n.className="toc-item-wrapper";const o=t.relativeLevel;n.style.setProperty("--toc-indent-multiplier",o.toString());const i=document.createElement("a");if(i.href=`#${t.id}`,i.textContent=t.text,i.className="toc-link tooltip tooltip-right",i.setAttribute("data-relative-level",t.relativeLevel.toString()),i.setAttribute("data-absolute-level",t.absoluteLevel.toString()),i.setAttribute("data-heading-id",t.id),i.setAttribute("data-tip",t.text),i.addEventListener("click",e=>{e.preventDefault(),this.smoothScrollToHeading(t.element)}),n.appendChild(i),t.children.length>0){const e=this.createDynamicTocHTML(t.children);n.appendChild(e)}e.appendChild(n)}),e},initAdaptiveLayout(){if(document.querySelector(".toc-container")){if(window.ResizeObserver){new ResizeObserver(()=>{this.updateTocLayout()}).observe(document.documentElement)}window.addEventListener("resize",()=>{clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{this.updateTocLayout()},150)}),this.updateTocLayout()}},updateTocLayout(){const t=document.querySelector(".toc-container");if(!t)return;const e=document.getElementById("toc-nav");if(!e)return;const n=e.scrollHeight>parseFloat(getComputedStyle(t).maxHeight);t.classList.toggle("has-scroll",n)},smoothScrollToHeading(t){if(!t)return;const e=t.offsetTop-80;window.scrollTo({top:e,behavior:"smooth"})},getMinHeadingLevel(t){let e=6;return t.forEach(t=>{const n=parseInt(t.tagName.charAt(1));n<e&&(e=n)}),e},initTocScrollHighlight(t){let e=!1;const n=()=>{const n=window.scrollY+120,o=window.innerHeight,i=document.documentElement.scrollHeight;let s=-1;n+o>=i-50?s=t.length-1:t.forEach((e,o)=>{const a=e.offsetTop,r=t[o+1],c=r?r.offsetTop:i;a<=n&&n<c&&(s=o)}),this.updateTocHighlight(s),e=!1};window.addEventListener("scroll",()=>{e||(requestAnimationFrame(n),e=!0)},{passive:!0}),n()},updateTocHighlight(t){document.querySelectorAll(".toc-link").forEach((e,n)=>{if(n===t){e.classList.add("active");const t=document.querySelector(".toc-container");t&&this.scrollToActiveItem(t,e)}else e.classList.remove("active")})},scrollToActiveItem(t,e){const n=t.scrollTop,o=t.clientHeight,i=t.scrollHeight;let s=0,a=e;for(;a&&a!==t&&(s+=a.offsetTop,a=a.offsetParent,a!==t););if(a!==t){const n=t.getBoundingClientRect().top+window.scrollY;s=e.getBoundingClientRect().top+window.scrollY-n+t.scrollTop}const r=e.offsetHeight,c=n,l=n+o,d=s,h=s+r;if(!(d>=c&&h<=l)){let e;const n=Math.max(0,i-o),a=0,m=o/2-r/2;if(e=s-m,e<a)e=s<o/3?a:Math.max(a,s-40);else if(e>n){e=i-s-r<o/3?n:Math.min(n,s-o+r+40)}if(h<c){e=c-h>o?Math.max(a,s-m):Math.max(a,s-20)}else if(d>l){e=d-l>o?Math.min(n,s-m):Math.min(n,s-o+r+20)}const u=t.scrollTop,p=Math.abs(e-u);if(p>5){const n=p>o?"auto":"smooth";t.scrollTo({top:e,behavior:n})}}},initReadingProgress(){const t=document.getElementById("reading-progress");if(!t)return;let e=!1;const n=()=>{const n=document.documentElement.scrollHeight-window.innerHeight,o=window.scrollY/n*100;t.style.width=`${Math.min(o,100)}%`,e=!1};window.addEventListener("scroll",()=>{e||(requestAnimationFrame(n),e=!0)},{passive:!0})},initCodeCopy(){document.querySelectorAll("pre code").forEach(t=>{const e=t.parentElement;if(!e)return;const n=document.createElement("button");n.className="absolute top-2 right-2 px-3 py-1 bg-base-200 hover:bg-base-300 rounded text-sm transition-colors",n.textContent="复制",n.setAttribute("aria-label","复制代码"),e.style.position="relative",e.appendChild(n),n.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(t.textContent),n.textContent="已复制",n.classList.add("bg-success","text-success-content"),setTimeout(()=>{n.textContent="复制",n.classList.remove("bg-success","text-success-content")},2e3)}catch(e){n.textContent="复制失败",setTimeout(()=>{n.textContent="复制"},2e3)}})})},initWordCount(){const t=document.getElementById("article-content"),e=document.getElementById("word-count"),n=document.getElementById("reading-time");if(!t||!e||!n)return;const o=t.cloneNode(!0);o.querySelectorAll("pre").forEach(t=>t.remove());const i=o.textContent||o.innerText||"",s=(i.match(/[\u4e00-\u9fa5]/g)||[]).length,a=(i.replace(/[\u4e00-\u9fa5]/g," ").match(/[a-zA-Z]+/g)||[]).length,r=s+a,c=Math.ceil(s/300+a/200);e.textContent=r.toLocaleString(),n.textContent=Math.max(1,c)},initScrollToTop(){const t=document.getElementById("scroll-to-top");if(!t)return;let e=!1;const n=()=>{window.scrollY>300?(t.classList.remove("opacity-0","pointer-events-none"),t.classList.add("opacity-100")):(t.classList.add("opacity-0","pointer-events-none"),t.classList.remove("opacity-100")),e=!1};window.addEventListener("scroll",()=>{e||(requestAnimationFrame(n),e=!0)},{passive:!0}),t.addEventListener("click",()=>{"scrollBehavior"in document.documentElement.style?window.scrollTo({top:0,behavior:"smooth"}):window.scrollTo(0,0)})}};document.addEventListener("DOMContentLoaded",()=>{t.init()})}();
